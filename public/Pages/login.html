<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="../CSS/globalLayout.css" />
    <link rel="stylesheet" href="../CSS/login.css" />
    <link rel="icon" href="../favicon.ico" />
    <title>WishCruncher</title>
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <script>
      // SDK를 초기화 합니다. 사용할 앱의 JavaScript 키를 설정해 주세요.
      Kakao.init("7573f9555b42ced32c395787d475bd06");

      // SDK 초기화 여부를 판단합니다.
      // console.log(Kakao.isInitialized());
    </script>
  </head>
  <body>
    <header id="header_container">
      <nav id="header_area">
        <div class="header_menu">
          <a id="header_Logo" href="../index.html"
            ><img src="../Images/logo.png"
          /></a>
        </div>
        <div class="header_menu header_text_menu">
          <span class="home_text_menu"> <a href="../index.html">Home</a></span>
          <span class="mypage_text_menu">MyPage</span>
        </div>
        <div class="header_menu login_menu">
          <span><a class="login_state" href="login.html">Login</a></span>
          <span class="logout_state">Logout</span>
        </div>
      </nav>
    </header>
    <main>
      <div id="login_Page">
        <div id="login_Page_Container">
          <form id="login_Form">
            <div id="login_Title">로그인</div>
            <label class="input_Label" for="email_Input">이메일</label>
            <input type="email" name="email_Input" required />
            <label class="input_Label" for="password_Input">비밀번호</label>
            <input
              id="password_input"
              type="password"
              name="password_Input"
              required
            />
            <div id="login_Warning_Message">로그인 정보를 확인해주세요</div>
            <button class="submit_Button">로그인</button>
          </form>
          <button id="kakao_Login_Button">
            <div id="kakao_Login_Button_Contents">
              <img src="../Images/kakaoLogo.svg" />
              <span>카카오 로그인</span>
            </div>
          </button>
          <div id="go_To_signUp">
            <a href="signup.html"
              >아직 이메일이 없으신가요? 회원가입 하러가기</a
            >
          </div>
        </div>
      </div>
    </main>
    <footer>
      <a href="https://github.com/choigicheol" target="_blank">
        <div class="github_Link">
          <img src="../Images/github_Icon.svg" />
          <span>Choi Gi Cheol</span>
        </div>
      </a>
    </footer>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="../firebase.js"></script>
    <script>
      const loginForm = document.querySelector("#login_Form");
      loginForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const email = loginForm["email_Input"].value;
        const password = loginForm["password_Input"].value;
        firebase
          .auth()
          .signInWithEmailAndPassword(email, password)
          .then((userCredential) => {
            login_Warning_Message.style.visibility = "hidden";
            window.location.replace("../index.html");
          })
          .catch((err) => {
            login_Warning_Message.style.visibility = "visible";
          });
      });
    </script>

    <script>
      const db = firebase.firestore();
      const kakaoLogin = document.querySelector("#kakao_Login_Button");
      const KAKAO_REST_API_KEY = "bd2e10a597f57c10609a98f50b97cd6c";
      const KAKAO_REDIRECT_URI =
        "https://wishcruncher-gigi.web.app/Pages/login.html";
      kakaoLogin.addEventListener("click", (e) => {
        e.preventDefault();
        Kakao.Auth.authorize({
          redirectUri: "https://wishcruncher-gigi.web.app/Pages/login.html",
        });
      });
      const code = window.location.search.split("=")[1];
      if (code) {
        let url = `https://kauth.kakao.com/oauth/token?grant_type=authorization_code&client_id=${KAKAO_REST_API_KEY}&redirect_uri=${KAKAO_REDIRECT_URI}&code=${code}`;
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((res) => res.json())
          .then((res) => {
            const access_Token = res.access_token;
            const kakaoUserInfo_API_URL = "http://localhost:8000/verifyToken";
            const data = {
              token: access_Token,
            };

            fetch(kakaoUserInfo_API_URL, {
              method: "POST",
              body: JSON.stringify(data),
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((res) => res.json())
              .then((res) => {
                const firebase_Token = res.firebase_token;
                firebase
                  .auth()
                  .signInWithCustomToken(firebase_Token)
                  .then((userCredential) => {
                    db.collection("users")
                      .doc(userCredential.user.uid)
                      .set({ nickname: userCredential.user.displayName })
                      .then((res) => {
                        window.location.replace("../index.html");
                      });
                  });
              });
          });
      }
    </script>
  </body>
</html>
