<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="../CSS/globalLayout.css" />
    <link rel="stylesheet" href="../CSS/signup.css" />
    <link rel="icon" href="../favicon.ico" />
    <title>WishCruncher</title>
  </head>
  <body>
    <header id="header_container"></header>
    <main>
      <div id="signup_page">
        <div id="signup_page_container">
          <form id="signup_form">
            <div id="signup_title">íšŒì›ê°€ì… ğŸ‰</div>
            <label class="input_label" for="email_input">ì´ë©”ì¼</label>
            <div id="email_input_area">
              <!-- ì´ë©”ì¼ ì…ë ¥ -->
              <input id="signup_email_input" class="margin0_input" type="email" name="email_input" required />
              <div id="check_email_button">ì¤‘ë³µê²€ì‚¬</div>
            </div>
            <div class="check_warning_message">
              <span id="check_email_fail_message">ì¤‘ë³µë˜ëŠ” ì´ë©”ì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤.</span>
              <span id="check_email_success_message">ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤.</span>
              <span id="check_email_invalid_message">ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.</span>
            </div>
            <!-- ë‹‰ë„¤ì„ ì…ë ¥ -->
            <label class="input_label" for="nickname_input">ë‹‰ë„¤ì„</label>
            <input id="nickname_input" name="nickname_input" required />
            <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ -->
            <label class="input_label" for="password_input">ë¹„ë°€ë²ˆí˜¸</label>
            <input
              id="password_input"
              type="password"
              name="password_input"
              placeholder="8~16ì, ì˜ë¬¸ ëŒ€ì†Œë¬¸ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”."
              required
            />
            <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì…ë ¥ -->
            <label class="input_label" for="confirm_password_input">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input
              id="confirm_password_input"
              class="margin0_input"
              type="password"
              name="confirm_password_input"
              required
            />
            <div class="check_warning_message">
              <span id="check_password_invalid_message">ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.</span>
            </div>
            <button class="submit_button" id="signup_button" name="signup_submit_button" disabled="true">í™•ì¸</button>
          </form>
          <div id="go_to_back">
            <a href="login.html">ë’¤ë¡œê°€ê¸°</a>
          </div>
        </div>
      </div>
    </main>
    <footer id="footer"></footer>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="../firebase.js"></script>

    <script type="module">
      import makeHeader from "../JavaScript/makeHeader.js";
      import makeFooter from "../JavaScript/makeFooter.js";
      makeHeader();
      makeFooter();
    </script>

    <script>
      const db = firebase.firestore();
    </script>
    <script src="../JavaScript/login.js"></script>
    <script>
      // ìœ íš¨ì„± ê²€ì‚¬
      function Inspect(data, type) {
        switch (type) {
          // 2~10ê¸€ì, ì˜ì–´, í•œê¸€, ìˆ«ìë§Œ ê°€ëŠ¥
          case "nickname":
            const nickname = /^([a-zA-Z0-9ê°€-í£]){2,10}$/;
            return nickname.test(data);
          case "email":
            const email = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/;
            return email.test(data);
          case "password":
            const password = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[$@$!%*?&])[A-Za-z\d$@$!%*?&]{8,16}/;
            //ìµœì†Œ 8ì ë° ìµœëŒ€ 16ì, ëŒ€ë¬¸ì í•˜ë‚˜ ì´ìƒ, ì†Œë¬¸ì í•˜ë‚˜ ì´ìƒ, ìˆ«ì í•˜ë‚˜ ì´ìƒ, íŠ¹ìˆ˜ ë¬¸ì í•˜ë‚˜ ì´ìƒ
            return password.test(data);
          default:
            return false;
        }
      }
      const checkEmail = document.querySelector("#check_email_button");
      const signupEmailInput = document.querySelector("#signup_email_input");
      let validEmail = false;
      let validNickname = false;
      let equalPasswordBoolean = false;
      // ì´ë©”ì¼ ì¤‘ë³µ ë²„íŠ¼ ì´ë²¤íŠ¸
      checkEmail.addEventListener("click", (e) => {
        e.preventDefault();
        const emailValue = signupEmailInput.value;
        firebase
          .auth()
          .signInWithEmailAndPassword(emailValue, "dummyPassword#9195")
          .catch((error) => {
            if (error.code === "auth/user-not-found") {
              check_email_fail_message.style.display = "none";
              check_email_success_message.style.display = "block";
              check_email_invalid_message.style.display = "none";
              validEmail = true;
            } else if (error.code === "auth/invalid-email") {
              check_email_fail_message.style.display = "none";
              check_email_success_message.style.display = "none";
              check_email_invalid_message.style.display = "block";
              validEmail = false;
            } else {
              check_email_fail_message.style.display = "block";
              check_email_success_message.style.display = "none";
              check_email_invalid_message.style.display = "none";
              validEmail = false;
            }
            validButton(validEmail, validNickname, equalPasswordBoolean);
          });
      });

      // ë‹‰ë„¤ì„ í™•ì¸
      const nicknameInput = document.querySelector("#nickname_input");
      nicknameInput.addEventListener("keyup", () => {
        if (Inspect(nicknameInput.value, "nickname")) {
          validNickname = true;
        } else {
          validNickname = false;
        }
        validButton(validEmail, validNickname, equalPasswordBoolean);
      });

      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì´ë²¤íŠ¸
      const passwordInput = document.querySelector("#password_input");
      const confirmPasswordInput = document.querySelector("#confirm_password_input");

      // ë¹„ë°€ë²ˆí˜¸, ë¹„ë°€ë²ˆí˜¸í™•ì¸ ì…ë ¥ ë™ì¼í•œì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
      function equalPassword(password, confirmPassword) {
        if (password.length >= 8 && password === confirmPassword) {
          check_password_invalid_message.style.display = "none";
          equalPasswordBoolean = true;
        } else {
          check_password_invalid_message.style.display = "block";
          equalPasswordBoolean = false;
        }
      }

      const signupSubmitButton = document.querySelector("#signup_button");
      // ë²„íŠ¼ í™œì„±í™” ì¡°ê±´ í•¨ìˆ˜
      function validButton(validEmail, validNickname, validPassword) {
        if (validEmail && validNickname && validPassword) {
          signupSubmitButton.disabled = false;
          signupSubmitButton.style.background = "#ab86df";
        } else {
          signupSubmitButton.disabled = true;
          signupSubmitButton.style.background = "#d2bdf0";
        }
      }

      passwordInput.addEventListener("keyup", () => {
        if (Inspect(passwordInput.value, "password")) {
          check_password_invalid_message.style.display = "none";
        } else {
          check_password_invalid_message.style.display = "block";
        }
        equalPassword(passwordInput.value, confirmPasswordInput.value);
        validButton(validEmail, validNickname, equalPasswordBoolean);
      });

      confirmPasswordInput.addEventListener("keyup", () => {
        if (Inspect(confirmPasswordInput.value, "password")) {
          check_password_invalid_message.style.display = "none";
        } else {
          check_password_invalid_message.style.display = "block";
        }
        equalPassword(passwordInput.value, confirmPasswordInput.value);
        validButton(validEmail, validNickname, equalPasswordBoolean);
      });

      // íšŒì›ê°€ì… ë²„íŠ¼ ì´ë²¤íŠ¸
      const signupForm = document.querySelector("#signup_Form");

      signupForm.addEventListener("submit", (e) => {
        e.preventDefault();
        firebase
          .auth()
          .createUserWithEmailAndPassword(signupEmailInput.value, passwordInput.value)
          .then((userInfo) => {
            db.collection("users")
              .doc(userInfo.user.uid)
              .set({
                profileImg:
                  "https://firebasestorage.googleapis.com/v0/b/wishcruncher.appspot.com/o/image%2Fbasic_Profile.png?alt=media&token=bec9d886-55d2-485d-8740-70bed7eb5239",
                nickname: nicknameInput.value,
                email: signupEmailInput.value,
              })
              .then((res) => {
                window.location.replace("./login.html");
              });
          });
      });
    </script>
  </body>
</html>
