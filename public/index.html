<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./CSS/globalLayout.css" />
    <link rel="stylesheet" href="./CSS/index.css" />
    <link rel="icon" href="./favicon.ico" />
    <title>WishCruncher</title>
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <script>
      // Kakao SDK Ï¥àÍ∏∞Ìôî
      Kakao.init("7573f9555b42ced32c395787d475bd06");
    </script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  </head>
  <body>
    <header id="header_container">
      <nav id="header_area">
        <div class="header_menu">
          <a id="header_logo" href="index.html"
            ><img src="./Images/logo.png" alt="logo"
          /></a>
        </div>
        <div class="header_menu header_text_menu">
          <span class="home_text_menu"><a href="index.html">Home</a></span>
          <span class="mypage_text_menu">MyPage</span>
        </div>
        <div class="header_menu login_menu">
          <span
            ><a class="login_state" href="./Pages/login.html">Login</a></span
          >
          <span class="logout_state">Logout</span>
        </div>
      </nav>
    </header>
    <main>
      <div id="main_page">
        <div class="side_bar">
          <div class="sidebar_title">Ïõî Ïó¨Ïú†Í∏àÏï°</div>
          <input id="money_Input" maxlength="24" />
          <div id="money_Button_Container">
            <div class="button_Row">
              <button name="won1000000" class="money_Button">
                + 1,000,000
              </button>
              <button name="won100000" class="money_Button left_Money_Button">
                + 100,000
              </button>
            </div>
            <div class="button_Row">
              <button name="won50000" class="money_Button">+ 50,000</button>
              <button name="won10000" class="money_Button left_Money_Button">
                + 10,000
              </button>
            </div>
            <div id="clear_Button">Clear</div>
          </div>
          <div id="operation_wish_level_box">
            <div class="sidebar_title">ÏµúÏÜå ÏúÑÏãú Î†àÎ≤®</div>
            <div id="wish_level_box">
              <button
                name="wish_level_minus"
                class="wish_level_operation_button"
              >
                -
              </button>
              <span id="wish_level">0</span>
              <button
                name="wish_level_plus"
                class="wish_level_operation_button"
              >
                +
              </button>
            </div>
          </div>
          <button id="sidebar_submit_button">Í≤∞Í≥ºÎ≥¥Í∏∞</button>
        </div>
        <!-- ÏúÑÏãúÎ¶¨Ïä§Ìä∏ Íµ¨Ïó≠ -->
        <div class="wish_list_container">
          <!-- ÏúÑÏãúÎ¶¨Ïä§Ìä∏ Ï†úÌíàÎì±Î°ù Ï∞Ω -->
          <div id="share_kakao_container">
            <span id="share_kakao">
              <img
                src="https://developers.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_medium.png"
                alt="Ïπ¥Ïπ¥Ïò§ÎßÅÌÅ¨ Î≥¥ÎÇ¥Í∏∞ Î≤ÑÌäº"
              />Í≥µÏú†ÌïòÍ∏∞
            </span>
          </div>
          <div id="add_item_box">
            <div id="add_item_button_box">
              <div id="add_item_button">
                <img id="plus_icon" src="./Images/plus_Icon.png" />
              </div>
            </div>
            <div id="add_item_contents">
              <div id="upload_photo_box">
                <div id="upload_image_box">
                  <img
                    id="upload_plus_image"
                    src="./Images/photo_Plus_Button.svg"
                    alt="+"
                  />
                  <img id="thumb_image" src="" alt="+" />
                </div>
                <input id="upload_Photo_Input" type="file" />
              </div>
              <div id="add_Item_Input_Area">
                <div class="add_Item_Input_Row">
                  <span class="add_Item_Input_Row_Category">Ï†úÌíà</span>
                  <input class="add_Item_Input" />
                </div>
                <div id="add_Item_Input_Row_Middle" class="add_Item_Input_Row">
                  <span class="add_Item_Input_Row_Category">Í∞ÄÍ≤©</span>
                  <input class="add_Item_Input" maxlength="24" />
                </div>
                <div class="add_Item_Input_Row">
                  <span class="add_Item_Input_Row_Category">ÏúÑÏãú Î†àÎ≤®</span>
                  <input
                    id="wish_level_range"
                    type="range"
                    max="10"
                    list="tickmarks"
                  />
                  <datalist id="tickmarks">
                    <option value="0"></option>
                    <option value="1"></option>
                    <option value="2"></option>
                    <option value="3"></option>
                    <option value="4"></option>
                    <option value="5"></option>
                    <option value="6"></option>
                    <option value="7"></option>
                    <option value="8"></option>
                    <option value="9"></option>
                    <option value="10"></option>
                  </datalist>
                  <div id="wish_level_label">
                    <span>0</span>
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>6</span>
                    <span>7</span>
                    <span>8</span>
                    <span>9</span>
                    <span>10</span>
                  </div>
                </div>
              </div>
            </div>
            <div id="regi_Item_Button_Box">
              <button id="regi_Item">Îì± Î°ù</button>
            </div>
          </div>

          <!-- ÏúÑÏãú Ï†úÌíà Î¶¨Ïä§Ìä∏ Íµ¨Ïó≠ -->
          <div id="user_Item_Area"></div>
        </div>
      </div>
      <div id="scroll_Top_Button">Top</div>
    </main>
    <footer>
      <a href="https://github.com/choigicheol" target="_blank">
        <div class="github_Link">
          <img src="./Images/github_Icon.svg" />
          <span>Choi Gi Cheol</span>
        </div>
      </a>
    </footer>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="./firebase.js"></script>
    <script>
      let userUid = null;
      const db = firebase.firestore();
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          userUid = user.uid;
        }
      });
    </script>
    <!-- Ïú†Ï†Ä Î°úÍ∑∏Ïù∏ -->
    <script src="JavaScript/login.js"></script>
    <!-- Ïú†Ï†Ä Î°úÍ∑∏ÏïÑÏõÉ -->
    <script src="JavaScript/logout.js"></script>
    <!-- ÎßàÏù¥ÌéòÏù¥ÏßÄ Ïù¥Îèô -->
    <script>
      const mypageMenu = document.querySelector(".mypage_text_menu");
      mypageMenu.addEventListener("click", (e) => {
        if (isLogin) {
          window.location.replace("./Pages/mypage.html");
        }
      });
    </script>
    <script>
      // const user_Item_Area = document.querySelector("#user_Item_Area");
    </script>
    <!-- Ïú†Ï†Ä Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú, ÏúÑÏãúÎ¶¨Ïä§Ìä∏ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌôïÏù∏ -->
    <script src="JavaScript/userItems.js"></script>
    <script>
      const user_Item_Area = document.querySelector("#user_Item_Area");
      let clientData = [];
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          userUid = user.uid;
          db.collection("users")
            .doc(user.uid)
            .collection("wish")
            .get()
            .then((res) => {
              if (!res.size) {
                showEmptyItem(user_Item_Area);
              } else {
                res.forEach((doc) => {
                  if (!doc.data().state) {
                    add_To_Item_List(doc.data(), user_Item_Area);
                  }
                });
              }
            });
        } else {
          userUid = null;
          showEmptyItem(user_Item_Area);
        }
      });
    </script>

    <!-- ÏúÑÏãúÎ¶¨Ïä§Ìä∏ Îì±Î°ù -->
    <!-- <script src="./JavaScript/addWishList.js"></script> -->
    <script>
      const storage = firebase.storage();
      const item_Input = document.querySelectorAll(".add_Item_Input");
      var item_Image_File = document.querySelector("#upload_Photo_Input");
      const thumbImage = document.querySelector("#thumb_image");

      item_Image_File.addEventListener("change", () => {
        item_Image_File.files[0].preview = URL.createObjectURL(
          item_Image_File.files[0]
        );
        thumbImage.setAttribute("src", item_Image_File.files[0].preview);
        upload_plus_image.style.display = "none";
        thumbImage.style.display = "block";
      });

      function uploadClientDatabaseItem(uploadUrl) {
        let item_Input_Data = {
          Ï†úÌíà: item_Input[0].value,
          Í∞ÄÍ≤©: `${item_Input[1].value} Ïõê`,
          ÏúÑÏãúÎ†àÎ≤®: selectWishLevel.value,
          imagePath: uploadUrl,
          state: 0,
        };
        if (
          item_Input[0].value.length > 0 &&
          item_Input[1].value.length > 0 &&
          selectWishLevel.value > 0
        ) {
          clientData.push(item_Input_Data);
          const lastItemId = clientData.length;
          item_Input_Data["id"] = lastItemId;
          add_To_Item_List(item_Input_Data, user_Item_Area);
          empty_Box.style.display = "none";
        }
        item_Input[0].value = null;
        item_Input[1].value = null;
        selectWishLevel.value = 0;
        upload_plus_image.style.display = "block";
        thumbImage.style.display = "none";
        item_Image_File.value = null;
      }

      function uploadUserDatabaseItem(uploadUrl) {
        let item_Input_Data = {
          Ï†úÌíà: item_Input[0].value,
          Í∞ÄÍ≤©: `${item_Input[1].value} Ïõê`,
          ÏúÑÏãúÎ†àÎ≤®: selectWishLevel.value,
          imagePath: uploadUrl,
          state: 0,
        };
        if (
          item_Input[0].value.length > 0 &&
          item_Input[1].value.length > 0 &&
          selectWishLevel.value > 0
        ) {
          db.collection("users")
            .doc(userUid)
            .collection("wish")
            .get()
            .then((res) => {
              if (res.size > 0) {
                const lastItemId = res.docs[res.size - 1].data().id;
                item_Input_Data["id"] = lastItemId + 1;
                db.collection("users")
                  .doc(userUid)
                  .collection("wish")
                  .doc(`item${lastItemId + 1}`)
                  .set(item_Input_Data);
              } else {
                empty_Box.style.display = "none";
                item_Input_Data["id"] = res.size + 10;
                db.collection("users")
                  .doc(userUid)
                  .collection("wish")
                  .doc(`item${res.size + 10}`)
                  .set(item_Input_Data);
              }
            })
            .then((res) => {
              add_To_Item_List(item_Input_Data, user_Item_Area);
            })
            .then((res) => {
              item_Input[0].value = null;
              item_Input[1].value = null;
              selectWishLevel.value = 0;
              upload_plus_image.style.display = "block";
              thumbImage.style.display = "none";
              item_Image_File.value = null;
            });
        }
      }

      // Îì±Î°ùÎ≤ÑÌäº ÎàåÎ†ÄÏùÑ Îïå ÏúÑÏãúÎ¶¨Ïä§Ìä∏ Ï∂îÍ∞Ä
      regi_Item.addEventListener("click", (e) => {
        var uploadUrl = `https://firebasestorage.googleapis.com/v0/b/wishcruncher.appspot.com/o/image%2FnoImage.png?alt=media&token=94dc86de-37ec-4971-8dbb-f15e5ce82a35`;
        e.preventDefault();
        if (isLogin) {
          if (item_Image_File.files[0]) {
            var storageRef = storage.ref();
            var imagePath = storageRef.child(
              "image/" + userUid + item_Image_File.files[0].name
            );
            var uploadImage = imagePath.put(item_Image_File.files[0]);
            uploadImage.on(
              "state_changed",
              null,
              (error) => {},
              () => {
                uploadImage.snapshot.ref.getDownloadURL().then((url) => {
                  uploadUserDatabaseItem(url);
                });
              }
            );
          } else {
            uploadUserDatabaseItem(uploadUrl);
          }
        } else {
          if (item_Image_File.files[0]) {
            uploadClientDatabaseItem(item_Image_File.files[0].preview);
          } else {
            uploadClientDatabaseItem(uploadUrl);
          }
        }
      });
    </script>

    <script>
      const scrollTopButton = document.querySelector("#scroll_Top_Button");
      const selectWishLevel = document.querySelector("#wish_level_range");
      scrollTopButton.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
      // ÏúÑÏãú Ï∂îÍ∞ÄÎ≤ÑÌäº transform, color Ï°∞Ï†ï
      const addItemButton = document.querySelector("#add_item_button");
      let isTransform = false;
      addItemButton.addEventListener("click", () => {
        isTransform = !isTransform;
        if (isTransform) {
          plus_icon.style.transform = "rotate(45deg)";
          add_item_button.style.background = "#FF7B7B";
          add_item_contents.style.display = "flex";
          regi_Item_Button_Box.style.display = "flex";
          selectWishLevel.value = 0;
        } else {
          plus_icon.style.transform = "";
          add_item_button.style.background = "#ab86df";
          add_item_contents.style.display = "none";
          regi_Item_Button_Box.style.display = "none";
          item_Input[0].value = null;
          item_Input[1].value = null;
          upload_plus_image.style.display = "block";
          thumbImage.style.display = "none";
          item_Image_File.value = null;
        }
      });
    </script>

    <script>
      // Í∞ÄÍ≤©Ïóê comma ÎÑ£Ïñ¥Ï£ºÍ∏∞ ÏúÑÌïú Ìï®Ïàò
      function makePriceComma(price) {
        const removeComma = price.split(",").join("");
        let priceLen = removeComma.length - 1;
        let result = "";
        let count = 0;
        if (price.length > 3) {
          for (let i = priceLen; i >= 0; i--) {
            result = removeComma[i] + result;
            count++;
            if (count % 3 === 0 && i) {
              result = "," + result;
            }
          }
        } else {
          result = price;
        }
        return result;
      }

      const add_Item_Price_Check =
        /^([0-9]*,*[0-9]*,*[0-9]*,*[0-9]*,*[0-9]*,*[0-9]*,*[0-9]*,*[0-9])$/;
      item_Input[1].addEventListener("keyup", () => {
        if (!add_Item_Price_Check.test(item_Input[1].value)) {
          item_Input[1].value = null;
        }
        if (item_Input[1].value[0] === "0") {
          item_Input[1].value = item_Input[1].value.slice(1);
        }
        item_Input[1].value = makePriceComma(item_Input[1].value);
      });
    </script>
    <script>
      // Ï∫°Ï≥êÍ∏∞Îä•
      const shareKakao = document.querySelector("#share_kakao");

      shareKakao.addEventListener("click", (e) => {
        e.preventDefault();

        let wishListResult = document.getElementById("result_Container");
        html2canvas(wishListResult).then((canvas) => {
          let imgUrl = canvas.toDataURL("image/jpeg");
          let realImgUrl = imgUrl.split(",")[1];

          fetch(imgUrl)
            .then((res) => res.blob())
            .then((blob) => {
              let resultFile = new File(
                [blob],
                `${Math.random() * 10000000000000000}`, // ÌååÏù¥Ïñ¥Î≤†Ïù¥Ïä§Ïóê Ï†ÄÏû•Ìï† Ïù¥ÎØ∏ÏßÄ Ïù¥Î¶Ñ
                {
                  type: "image/png",
                }
              );
              return resultFile;
            })
            .then((res) => {
              let storageRef = storage.ref();
              let imagePath = storageRef.child("result/" + res.name);
              let uploadImage = imagePath.put(res);
              uploadImage.on(
                "state_changed",
                null,
                (error) => {},
                () => {
                  uploadImage.snapshot.ref
                    .getDownloadURL()
                    .then((resultUrl) => {
                      Kakao.Link.sendDefault({
                        objectType: "feed",
                        content: {
                          title:
                            "üí∏ WishCruncherÏóêÏÑú ÏûêÏã†Ïùò ÏúÑÏãúÎ¶¨Ïä§Ìä∏Î•º Í≥ÑÌöçÌï¥Î≥¥ÏÑ∏Ïöî.",
                          imageUrl:
                            "https://firebasestorage.googleapis.com/v0/b/wishcruncher.appspot.com/o/image%2FnoImage.png?alt=media&token=94dc86de-37ec-4971-8dbb-f15e5ce82a35",
                          link: {
                            mobileWebUrl:
                              "https://wishcruncher-gigi.web.app/index.html",
                          },
                        },

                        buttons: [
                          {
                            title: "Í≤∞Í≥ºÎ≥¥Í∏∞",
                            link: {
                              mobileWebUrl: resultUrl,
                            },
                          },
                          {
                            title: "ÏõπÏúºÎ°ú Ïù¥Îèô",
                            link: {
                              mobileWebUrl:
                                "https://wishcruncher-gigi.web.app/index.html",
                            },
                          },
                        ],
                      });
                    });
                }
              );
            });
        });
      });
    </script>
    <script src="./JavaScript/sidebar.js"></script>
  </body>
</html>
