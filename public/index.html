<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./CSS/globalLayout.css" />
    <link rel="stylesheet" href="./CSS/index.css" />
    <link rel="icon" href="./favicon.ico" />
    <title>WishCruncher</title>
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <script>
      // Kakao SDK 초기화
      Kakao.init("7573f9555b42ced32c395787d475bd06");
    </script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  </head>
  <body>
    <header id="header_container">
      <nav id="header_area">
        <div class="header_menu">
          <a id="header_Logo" href="index.html"
            ><img src="./Images/logo.png" alt="logo"
          /></a>
        </div>
        <div class="header_menu header_text_menu">
          <span class="home_text_menu"><a href="index.html">Home</a></span>
          <span class="mypage_text_menu">MyPage</span>
        </div>
        <div class="header_menu login_menu">
          <span
            ><a class="login_state" href="./Pages/login.html">Login</a></span
          >
          <span class="logout_state">Logout</span>
        </div>
      </nav>
    </header>
    <main>
      <div id="main_Page">
        <div class="side_Bar">
          <div class="sidebar_Title">월 여유금액</div>
          <input id="money_Input" maxlength="24" />
          <div id="money_Button_Container">
            <div class="button_Row">
              <button name="won1000000" class="money_Button">
                + 1,000,000
              </button>
              <button name="won100000" class="money_Button left_Money_Button">
                + 100,000
              </button>
            </div>
            <div class="button_Row">
              <button name="won50000" class="money_Button">+ 50,000</button>
              <button name="won10000" class="money_Button left_Money_Button">
                + 10,000
              </button>
            </div>
            <div id="clear_Button">Clear</div>
          </div>
          <div id="operation_Wish_Level_Box">
            <div class="sidebar_Title">최소 위시 레벨</div>
            <div id="Wish_Level_Box">
              <button
                name="wish_Level_Minus"
                class="wish_Level_Operation_Button"
              >
                -
              </button>
              <span id="wish_Level">0</span>
              <button
                name="wish_Level_Plus"
                class="wish_Level_Operation_Button"
              >
                +
              </button>
            </div>
          </div>
          <button id="sidebar_Submit_Button">결과보기</button>
        </div>
        <!-- 위시리스트 구역 -->
        <div class="wish_List_Container">
          <!-- 위시리스트 제품등록 창 -->
          <div id="share_Kakao_Container">
            <span id="share_Kakao">
              <img
                src="https://developers.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_medium.png"
                alt="카카오링크 보내기 버튼"
              />공유하기
            </span>
          </div>
          <div id="add_Item_Box">
            <div id="add_Item_Button_Box">
              <div id="add_Item_Button">
                <img id="plus_Icon" src="./Images/plus_Icon.png" />
              </div>
            </div>
            <div id="add_Item_Contents">
              <div id="upload_Photo_Box">
                <div id="upload_Image_Box">
                  <img
                    id="upload_Plus_Image"
                    src="./Images/photo_Plus_Button.svg"
                    alt="+"
                  />
                  <img id="thumb_Image" src="" alt="+" />
                </div>
                <input id="upload_Photo_Input" type="file" />
              </div>
              <div id="add_Item_Input_Area">
                <div class="add_Item_Input_Row">
                  <span class="add_Item_Input_Row_Category">제품</span>
                  <input class="add_Item_Input" />
                </div>
                <div id="add_Item_Input_Row_Middle" class="add_Item_Input_Row">
                  <span class="add_Item_Input_Row_Category">가격</span>
                  <input class="add_Item_Input" maxlength="24" />
                </div>
                <div class="add_Item_Input_Row">
                  <span class="add_Item_Input_Row_Category">위시 레벨</span>
                  <input
                    id="wish_level_range"
                    type="range"
                    max="10"
                    list="tickmarks"
                  />
                  <datalist id="tickmarks">
                    <option value="0"></option>
                    <option value="1"></option>
                    <option value="2"></option>
                    <option value="3"></option>
                    <option value="4"></option>
                    <option value="5"></option>
                    <option value="6"></option>
                    <option value="7"></option>
                    <option value="8"></option>
                    <option value="9"></option>
                    <option value="10"></option>
                  </datalist>
                  <div id="wish_level_label">
                    <span>0</span>
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>6</span>
                    <span>7</span>
                    <span>8</span>
                    <span>9</span>
                    <span>10</span>
                  </div>
                </div>
              </div>
            </div>
            <div id="regi_Item_Button_Box">
              <button id="regi_Item">등 록</button>
            </div>
          </div>

          <!-- 위시 제품 리스트 구역 -->
          <div id="user_Item_Area"></div>
        </div>
      </div>
      <div id="scroll_Top_Button">Top</div>
    </main>
    <footer>
      <a href="https://github.com/choigicheol" target="_blank">
        <div class="github_Link">
          <img src="./Images/github_Icon.svg" />
          <span>Choi Gi Cheol</span>
        </div>
      </a>
    </footer>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="./firebase.js"></script>
    <script>
      // 위시리스트 삭제
      setTimeout(() => {
        var allDeleteButton = document.querySelectorAll(".delete_Button");
        var allItemBox = document.querySelectorAll(".item_Box");
        allDeleteButton.forEach((deleteBtn, idx) => {
          deleteBtn.addEventListener("click", (e) => {
            db.collection("users")
              .doc(userUid)
              .collection("wish")
              .doc(`item${e.target.id}`)
              .delete()
              .then((res) => {
                allItemBox[idx].style.display = "none";
              })
              .then((res) => {
                db.collection("users")
                  .doc(userUid)
                  .collection("wish")
                  .get()
                  .then((res) => {
                    if (!res.size) {
                      showEmptyItem();
                    }
                  });
              });
          });
        });
      }, 3000);
    </script>
    <!-- 위시리스트 등록 -->
    <script src="./JavaScript/addWishList.js"></script>
    <!-- 유저 로그인 상태, 위시리스트 데이터베이스 확인 -->
    <script src="JavaScript/userItems.js"></script>

    <!-- 유저 로그아웃 -->
    <script src="JavaScript/logout.js"></script>
    <script>
      const scrollTopButton = document.querySelector("#scroll_Top_Button");
      const selectWishLevel = document.querySelector("#wish_level_range");
      scrollTopButton.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
      // 위시 추가버튼 transform, color 조정
      const addItemButton = document.querySelector("#add_Item_Button");
      let isTransform = false;
      addItemButton.addEventListener("click", () => {
        isTransform = !isTransform;
        if (isTransform) {
          plus_Icon.style.transform = "rotate(45deg)";
          add_Item_Button.style.background = "#FF7B7B";
          add_Item_Contents.style.display = "flex";
          regi_Item_Button_Box.style.display = "flex";
          selectWishLevel.value = 0;
        } else {
          plus_Icon.style.transform = "";
          add_Item_Button.style.background = "#ab86df";
          add_Item_Contents.style.display = "none";
          regi_Item_Button_Box.style.display = "none";
          item_Input[0].value = null;
          item_Input[1].value = null;
          upload_Plus_Image.style.display = "block";
          thumb_Image.style.display = "none";
          item_Image_File.value = null;
        }
      });
    </script>

    <script>
      // 가격에 comma 넣어주기 위한 함수
      function makePriceComma(price) {
        const removeComma = price.split(",").join("");
        let priceLen = removeComma.length - 1;
        let result = "";
        let count = 0;
        if (price.length > 3) {
          for (let i = priceLen; i >= 0; i--) {
            result = removeComma[i] + result;
            count++;
            if (count % 3 === 0 && i) {
              result = "," + result;
            }
          }
        } else {
          result = price;
        }
        return result;
      }

      const add_Item_Price_Check =
        /^([0-9]*,*[0-9]*,*[0-9]*,*[0-9]*,*[0-9]*,*[0-9]*,*[0-9]*,*[0-9])$/;
      item_Input[1].addEventListener("keyup", () => {
        if (!add_Item_Price_Check.test(item_Input[1].value)) {
          item_Input[1].value = null;
        }
        if (item_Input[1].value[0] === "0") {
          item_Input[1].value = item_Input[1].value.slice(1);
        }
        item_Input[1].value = makePriceComma(item_Input[1].value);
      });
    </script>
    <script>
      // 캡쳐기능
      const shareKakao = document.querySelector("#share_Kakao");

      shareKakao.addEventListener("click", (e) => {
        e.preventDefault();

        let wishListResult = document.getElementById("result_Container");
        html2canvas(wishListResult).then((canvas) => {
          let imgUrl = canvas.toDataURL("image/jpeg");
          let realImgUrl = imgUrl.split(",")[1];

          fetch(imgUrl)
            .then((res) => res.blob())
            .then((blob) => {
              let resultFile = new File(
                [blob],
                `${Math.random() * 10000000000000000}`, // 파이어베이스에 저장할 이미지 이름
                {
                  type: "image/png",
                }
              );
              return resultFile;
            })
            .then((res) => {
              let storageRef = storage.ref();
              let imagePath = storageRef.child("result/" + res.name);
              let uploadImage = imagePath.put(res);
              uploadImage.on(
                "state_changed",
                null,
                (error) => {},
                () => {
                  uploadImage.snapshot.ref
                    .getDownloadURL()
                    .then((resultUrl) => {
                      Kakao.Link.sendDefault({
                        objectType: "feed",
                        content: {
                          title:
                            "💸WishCruncher에서 자신의 위시리스트를 계획해보세요.",
                          imageUrl:
                            "https://firebasestorage.googleapis.com/v0/b/wishcruncher.appspot.com/o/image%2FnoImage.png?alt=media&token=94dc86de-37ec-4971-8dbb-f15e5ce82a35",
                          link: {
                            mobileWebUrl:
                              "https://wishcruncher-gigi.web.app/index.html",
                          },
                        },

                        buttons: [
                          {
                            title: "결과보기",
                            link: {
                              mobileWebUrl: resultUrl,
                            },
                          },
                          {
                            title: "웹으로 이동",
                            link: {
                              mobileWebUrl:
                                "https://wishcruncher-gigi.web.app/index.html",
                            },
                          },
                        ],
                      });
                    });
                }
              );
            });
        });
      });
    </script>
    <script src="./JavaScript/sidebar.js"></script>
  </body>
</html>
